<?xml version="1.0" encoding="UTF-8"?>
<project name="mpower" basedir=".." default="deploy">

	<target name="deploy" description="Deploy build output and populate database" >

		<property name="dev.build.file" value="${basedir}/build/build.xml" />
		<property name="load.base.data.file" value="${basedir}/build/build-base-data.xml" />

		
		<property name="mysql.db.driver" value="com.mysql.jdbc.Driver" />
		<property name="mysql.db.url" value="jdbc:mysql://localhost:${mysql.port}/mpoweropen?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=UTF8" />
		<property name="mysql.db.user" value="mpower" />
		<property name="mysql.db.pw" value="mpower" />
		<property name="mysql.db.dialect" value="org.hibernate.dialect.MySQLInnoDBDialect" />
		<property name="mysql.db.classpath" value="${target.tomcat.dir}/lib/mysql-connector-java-5.0.8-bin.jar" />


		<!-- Reset schema -->
	     <sql driver="${mysql.db.driver}"
		          url="${mysql.db.url}"
		          userid="${mysql.db.user}"
		          password="${mysql.db.pw}"
		          encoding="UTF-8"
		          classpath="${mysql.db.classpath}">
		    <transaction src="${basedir}/db/clearSchema.sql"/>
	    </sql>

		<exec executable="${target.tomcat.dir}/bin/shutdown.sh" spawn="true" />
		<sleep seconds="30" />
		<delete dir="${target.tomcat.dir}/work" />
		<delete dir="${target.tomcat.dir}/temp" />
		<delete dir="${target.tomcat.dir}/webapps/mpower" />

		
		<!-- JPA recreates the tables when loading the new .war if they don't exist -->
		<copy file="${build.output.dir}/mpower.war" todir="${target.tomcat.dir}/webapps" overwrite="true"  />

		<exec executable="${target.tomcat.dir}/bin/startup.sh" spawn="true" />
		<sleep seconds="90" />
		
		<!-- for a clean base new instance -->
		<!-- <ant antfile="${load.base.data.file}" target="load.base.data" /> -->

		<!-- for a dev data new instance -->
		<ant antfile="${dev.build.file}" target="9. Load Data" />
		
    </target> 
	
</project>
