<?xml version="1.0" encoding="UTF-8"?>
<project name="mpower" basedir=".." default="8. Redeploy and Restart Tomcat">
	<property name="internal.build.file" value="${basedir}/build/mpower-build.xml" />
	<property file="${basedir}/build/build.properties" />
	<property file="${commonBuild.dir}/commonBuild.properties"/>
	<property name="build.env" value="dev"/>

	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${antcontrib.jar}" />
		</classpath>
	</taskdef>
	
	<target name="clean" description="Cleans the staging area. Does not undeploy the application(s).">
		<ant antfile="${internal.build.file}" target="clean" />
	</target>

	<target name="1. Deploy Exploded War" description="Deploys the exploded war.">
		<ant antfile="${internal.build.file}" target="deploy-exploded-war" />
	</target>

	<target name="2. Deploy War" description="Deploys the unexploded war.">
		<ant antfile="${internal.build.file}" target="deploy-integrated-war" />
	</target>

	<target name="3. Undeploy War" description="Undeploys war file(s).">
		<ant antfile="${internal.build.file}" target="undeploy-war" />
	</target>

	<target name="4. Start Tomcat - Debug Mode">
	    <java jar="${appserver.home}/bin/bootstrap.jar" fork="true">
	        <jvmarg value="-Dcatalina.home=${appserver.home}"/>
	        <jvmarg value="-Xdebug"/>
	        <jvmarg value="-Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=n"/>
	    	<jvmarg value="-Xms128M" />
	    	<jvmarg value="-Xmx512m" />
	    	<jvmarg value="-XX:MaxPermSize=512M" />
	    </java>
	</target>

	<target name="5. Stop Tomcat">
	    <java jar="${appserver.home}/bin/bootstrap.jar" fork="true">
	        <jvmarg value="-Dcatalina.home=${appserver.home}"/>
	        <arg value="stop"/>
	    </java>
	</target>

	<target name="6. Generate Java Docs" description="Generates Javadocs for the entire application.">
		<ant antfile="${internal.build.file}" target="generate-javadocs" />
	</target>

	<target name="7. Deploy and Start Tomcat" depends="clean, 3. Undeploy War, 2. Deploy War, 4. Start Tomcat - Debug Mode"/>

	<target name="8. Redeploy and Restart Tomcat">
		<trycatch>
			<try>
				<antcall target="5. Stop Tomcat"/>
			</try>
		</trycatch>
		<sleep seconds="10"/>
		<antcall target="3. Undeploy War"/>
		<antcall target="1. Deploy Exploded War"/>
		<antcall target="4. Start Tomcat - Debug Mode"/>
	</target>

	<target name="9. Load Data">
	     <sql driver="${mysql.db.driver}"
	          url="${mysql.db.url}"
	          userid="${mysql.db.user}"
	          password="${mysql.db.pw}"
	          encoding="UTF-8"
	          classpath="${mysql.db.classpath}">
	     	<transaction src="${basedir}/db/clearTable.sql"/>
	     	<transaction src="${basedir}/db/prod/domain/address.sql"/>
	     	<transaction src="${basedir}/db/prod/domain/email.sql"/>
	     	<transaction src="${basedir}/db/prod/domain/phone.sql"/>
	     	<transaction src="${basedir}/db/prod/domain/common.sql"/>
	     	<transaction src="${basedir}/db/prod/domain/person.sql"/>
	     	<transaction src="${basedir}/db/prod/domain/gift.sql"/>
	     	<transaction src="${basedir}/db/prod/domain/commitment.sql"/>
	     	<transaction src="${basedir}/db/prod/domain/paymentSource.sql"/>
	     	<transaction src="${basedir}/db/prod/domain/fieldRelationship.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/person.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/personSearch.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/personSearchResults.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/giftView.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/paymentManager.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/paymentSource.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/paymentManagerEdit.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/countryPicklist.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/maritalStatusPicklist.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/suffixPicklist.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/titlePicklist.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/paymentTypePicklist.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/creditCardTypePicklist.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/frequencyPicklist.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/statusPicklist.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/recurringPicklist.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/stateprovince.sql"/>
	     	<transaction src="${basedir}/db/prod/picklists/constituentAttributesPicklist.sql"/>
	     	<!-- Setup payment type picklist and add to gift page -->
	     	<transaction src="${basedir}/db/prod/pages/gift.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/giftList.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/giftSearch.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/giftSearchResults.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/recurringGift.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/recurringGiftView.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/recurringGiftList.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/recurringGiftSearch.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/recurringGiftSearchResults.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/pledge.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/pledgeView.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/pledgeList.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/pledgeSearch.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/pledgeSearchResults.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/membership.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/membershipView.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/membershipList.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/membershipSearch.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/membershipSearchResults.sql"/>
	     	<!-- Add development data -->
	     	<transaction src="${basedir}/db/dev/devSetup/siteSetup.sql"/>
	     	<transaction src="${basedir}/db/prod/domain/code.sql"/>
	     	<transaction src="${basedir}/db/dev/devSetup/personSetup.sql"/>
	     	<transaction src="${basedir}/db/dev/devSetup/addressSetup.sql"/>
	     	<transaction src="${basedir}/db/dev/devSetup/emailSetup.sql"/>
	     	<transaction src="${basedir}/db/dev/devSetup/phoneSetup.sql"/>
	     	<transaction src="${basedir}/db/dev/devSetup/giftSetup.sql"/>
	     	<transaction src="${basedir}/db/dev/devSetup/businessRulesSetup.sql"/>
	     	<transaction src="${basedir}/db/dev/giftPaymentTypeDefault.sql"/>
	     	<transaction src="${basedir}/db/dev/customRoleTest/personSearch.sql"/>
	     	<transaction src="${basedir}/db/dev/customRoleTest/personSearchResults.sql"/>
	     	<transaction src="${basedir}/db/dev/customRoleTest/giftSearchResults.sql"/>
	     	<transaction src="${basedir}/db/dev/fieldValidation.sql"/>
	     	<transaction src="${basedir}/db/dev/pageAccess.sql"/>
	     	<transaction src="${basedir}/db/dev/devSetup/conferenceDemoData.sql"/>
	     	<transaction src="${basedir}/db/dev/queryLookup.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/queryLookup.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/addressManager.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/address.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/addressManagerEdit.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/emailManager.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/email.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/emailManagerEdit.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/phoneManager.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/phone.sql"/>
	     	<transaction src="${basedir}/db/prod/pages/phoneManagerEdit.sql"/>
	     	<transaction src="${basedir}/db/dev/devSetup/rolluptest.sql"/>
	     </sql>
	</target>
	
	<target name="9.1. Clear Schema">
	     <sql driver="${mysql.db.driver}"
	          url="${mysql.db.url}"
	          userid="${mysql.db.user}"
	          password="${mysql.db.pw}"
	          encoding="UTF-8"
	          classpath="${mysql.db.classpath}">
	     	<transaction src="${basedir}/db/clearSchema.sql"/>
		 </sql>
	</target>

	<target name="app.synch" description="Syncs the XHTML, JSP, JS, CSS, and Images of the project with a running application.">
		<ant antfile="${internal.build.file}" target="app.synch" />
	</target>

	<target name="resolve" description="Resolve dependencies.">
		<ant antfile="${internal.build.file}" target="resolve" />
	</target>
	
	<target name="build">
		<ant antfile="${internal.build.file}" target="build" />
	</target>

	<target name="publish-local" description="Publish artifacts to the local repository">
		<ant antfile="${internal.build.file}" target="publish-local" />
	</target>

	<target name="publish" description="Publish artifacts to the shared company repository">
		<ant antfile="${internal.build.file}" target="publish" />
	</target> 

	<target name="clean-local" description="cleans the local repository for the current module">
		<ant antfile="${internal.build.file}" target="clean-local" />
	</target> 

	<target name="uberclean" description="delete the ivy local repository, ivy cache, and project build">
		<ant antfile="${internal.build.file}" target="uberclean" />
	</target> 
	
	<target name="usage">
		<echo>This is the build file for MPowerOpen</echo>
		<echo>Use "clean" to delete the temporary build directories in the project.</echo>
		<echo>Use "Deploy Exploded War" to deploy the application as an exploded war</echo>
		<echo>Use "Deploy War" to deploy the war unexploded</echo>
		<echo>Use "Start Tomcat - Debug Mode" to start Tomcat in debug mode.
			You will need to configure remote debugging in eclipse (port 8000) to connect.</echo>
		<echo>Use "Stop Tomcat" to shut down the running server</echo>
		<echo>Use "Generate Java Docs" to generate javadocs from source code</echo>
		<echo>Use "Load Data" to truncate and load initial data</echo>
		<echo>Use "app.synch" to synchronize the JSPs, images, CSS,
			and JS files with the server.  This can be configured to happen
			automatically when something is saved in Eclipse.</echo>
		<echo>Use "resolve" to resolve dependencies using Ivy</echo>
		<echo>Use "publish" to publish artifacts to the Shared repository</echo>
		<echo>Use "publish-local" to publish artifacts to the Local repository</echo>
		<echo>Use "clean-local" to clean the Local repository for the current module</echo>
		<echo>Use "uberclean" to delete the ivy local repository, ivy cache, and project build</echo>
	</target>

</project>
