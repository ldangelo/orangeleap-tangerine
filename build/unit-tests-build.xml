<?xml version="1.0" encoding="UTF-8"?>
<project name="mpower-unittests" default="runall" basedir="..">
	<description>
    	MPower Test Execution File
    </description>

	<property file="${basedir}/build/build.properties" />
	<property file="${commonBuild.dir}/commonBuild.properties"/>

	<import file="${build.dir}/mpower-build.xml"/>
	<property name="build.env" value="unit-test"/>

	<target name="init" depends="resolve">
		<taskdef resource="testngtasks">
			<classpath path="${test.lib}"/>
		</taskdef>
	</target>
	
	<target name="buildall" depends="init">
		<antcall target="build">
			<param name="build.env" value="unit-test"/>
		</antcall>
		<mkdir dir="${stage.dir}/test-folder"/>

		<path id="compile-lib">
			<pathelement path="${compile.lib}"/>
			<pathelement path="${test.lib}"/>
			<pathelement path="${war.lib}"/>
			<fileset file="${stage.dir}/*.jar"/>
		</path>

		<javac
			destdir="${stage.dir}/test-folder"
			classpathref="compile-lib"
			srcdir="${test.src.dir}"
			debug="true"
        />
		
		<copy todir="${stage.dir}/test-folder">
			<fileset dir="${test.src.dir}">
				<include name="**/*.*"/>
				<exclude name="**/*.java"/>
			</fileset>
		</copy>

		<jar destfile="${stage.dir}/mpower-tests.jar" basedir="${stage.dir}/test-folder">
			<include name="**/*.*"/>
			<exclude name="**/persistence.xml"/>
		</jar>
		
		<copy todir="${stage.dir}">
			<fileset dir="${stage.dir}/test-folder">
				<include name="**/testng.xml"/>
			</fileset>
		</copy>

		<delete dir="${stage.dir}/test-folder"/>
		
	</target>

    <target name="runall" depends="buildall">
    	<path id="test-lib-path">
			<pathelement path="${compile.lib}"/>
			<pathelement path="${test.lib}"/>
			<pathelement path="${war.lib}"/>
			<fileset file="${stage.dir}/*.jar"/>
    	</path>

    	<mkdir dir="${stage.dir}/test-output"/>

    	<testng classpathref="test-lib-path"
    		outputdir="${stage.dir}/test-output" dumpcommand="yes" failureProperty="test.failed">
    		<xmlfileset dir="${stage.dir}" includes="**/testng.xml"/>
    	</testng>

    	<mkdir dir="${stage.dir}/report"/>

    	<junitreport todir="${stage.dir}/report">
        	<fileset dir="${stage.dir}/test-output">
        		<include name="**/*.xml"/>
        		<exclude name="**/testng-failed.xml"/>
        	</fileset>
		</junitreport>

        <fail message="Tests failed: check test reports." if="test.failed" />

    	<echo>Report available at ${basedir}/report/index.html</echo>
    </target>

</project>