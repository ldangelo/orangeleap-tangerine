package com.mpower.entity

import com.mpower.domain.Person;
import com.mpower.service.PersonService;
import com.mpower.service.GiftService;
import com.mpower.service.rule.SpouseMatchNotFound;
import java.util.Date;
import java.util.

global org.springframework.context.ApplicationContext applicationContext;
/*
rule "Person - Save Changes - Spouse Match Not Found"
	no-loop true
	when
		SpouseMatchNotFound()
		p : Person(spouseFirstName != null)
	then
		System.out.println("rule 1");
		String title;
		if (p.getTitle().equals("Mr.")) {
			title = "Mrs.";
		} else {
			title = "Mr.";
		}
		PersonService personService = (PersonService)applicationContext.getBean("personService");
		Person spouse = personService.createDefaultPerson(1L);
		spouse.setTitle(title);
		spouse.setFirstName(p.getSpouseFirstName());
		spouse.setLastName(p.getLastName());
		spouse.setMaritalStatus("Married");
		spouse.setSpouseFirstName(p.getFirstName());
		personService.maintainPerson(spouse);
		retract(SpouseMatchNotFound);
end

rule "Person - Save Changes - Spouse Match Found"
	no-loop true
	when
		p : Person(spouseFirstName != null) 
	then
		System.out.println("Rule 2");
		PersonService personService = (PersonService)applicationContext.getBean("personService");
		Person spouse = personService.matchSpouseLogically(p.getSpouseFirstName(), p.getLastName());
		if (spouse != null) {
			if ((spouse.getSpouseFirstName() == null) && (spouse.getLastName().equals(p.getLastName()))) {
				spouse.setSpouseFirstName(p.getFirstName());
				p.setSpouseFirstName(spouse.getFirstName());
				p.setMaritalStatus("Married");
				spouse.setMaritalStatus("Married");
				personService.maintainPerson(spouse);
				personService.maintainPerson(p);
			}
		} else {
			insert(new SpouseMatchNotFound(false));
		}
end

rule "Person - Save Changes - Single Yet Has Spouse"
	no-loop true
	when
		p : Person(spouseFirstName != null, maritalStatus == "Single")
	then
		System.out.println("rule 3");
		PersonService personService = (PersonService)applicationContext.getBean("personService");
		p.setMaritalStatus("Married");
		personService.maintainPerson(p);
end

rule "Person - Save Changes - Single"
	no-loop true
	when
		p : Person(spouseFirstName == null)
	then
		System.out.println("Single");
end

#Person 'x' makes a donation has been made
#Person 'x' has donated 'y' amount over a period of 'n' (number) 't' (units of time)
*/
rule "Gift - Donation Made - Analyze Major Donor"
	when
		$g : Gift($personId : personId)
	then
		PersonService personService = (PersonService)applicationContext.getBean("personService");
		GiftService giftService = (GiftService)applicationContext.getBean("giftService");
		int totalDonations = giftService.analyzeMajorDonor($personId,  "2008-01-01", "2008-06-01");
		if (totalDonation > 500) {
			Person person = personService.readPersonById($personId);
			person.setMajorDonor(true);
			personService.maintainPerson(person);
		}
end



