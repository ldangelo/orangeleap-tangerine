<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ADDRESS">

    <resultMap id="ADDRESS_RESULT" class="com.mpower.domain.model.communication.Address">
        <result property="id" column="ADDRESS_ID" jdbcType="BIGINT"/>
        <result property="activationStatus" column="ADDRESS_ACTIVATION_STATUS" jdbcType="VARCHAR"/>
        <result property="addressLine1" column="ADDRESS_LINE_1" jdbcType="VARCHAR"/>
        <result property="addressLine2" column="ADDRESS_LINE_2" jdbcType="VARCHAR"/>
        <result property="addressLine3" column="ADDRESS_LINE_3" jdbcType="VARCHAR"/>
        <result property="addressType" column="ADDRESS_TYPE" jdbcType="VARCHAR"/>
        <result property="city" column="ADDRESS_CITY" jdbcType="VARCHAR"/>
        <result property="comments" column="ADDRESS_COMMENT" jdbcType="VARCHAR"/>
        <result property="country" column="ADDRESS_COUNTRY" jdbcType="VARCHAR"/>
        <result property="createDate" column="ADDRESS_CREATE_DATE" jdbcType="TIMESTAMP"/>
        <result property="effectiveDate" column="ADDRESS_EFFECTIVE_DATE" jdbcType="TIMESTAMP"/>
        <result property="inactive" column="ADDRESS_INACTIVE" jdbcType="CHAR"/>
        <result property="postalCode" column="ADDRESS_POSTAL_CODE" jdbcType="VARCHAR"/>
        <result property="receiveMail" column="ADDRESS_RECEIVE_CORRESPONDENCE" jdbcType="CHAR"/>
        <result property="seasonalEndDate" column="ADDRESS_SEASONAL_END_DATE" jdbcType="TIMESTAMP"/>
        <result property="seasonalStartDate" column="ADDRESS_SEASONAL_START_DATE" jdbcType="TIMESTAMP"/>
        <result property="stateProvince" column="ADDRESS_STATE_PROVINCE" jdbcType="VARCHAR"/>
        <result property="temporaryEndDate" column="ADDRESS_TEMPORARY_END_DATE" jdbcType="TIMESTAMP"/>
        <result property="temporaryStartDate" column="ADDRESS_TEMPORARY_START_DATE" jdbcType="TIMESTAMP"/>
        <result property="updateDate" column="ADDRESS_UPDATE_DATE" jdbcType="TIMESTAMP"/>
        <result property="personId" column="ADDRESS_CONSTITUENT_ID" jdbcType="BIGINT"/>
		<result property="primary" column="ADDRESS_IS_PRIMARY" jdbcType="CHAR" />
    </resultMap>

    <sql id="ADDRESS_COLS_FRAGMENT">
        addr.ADDRESS_ID, addr.ACTIVATION_STATUS as ADDRESS_ACTIVATION_STATUS, addr.ADDRESS_LINE_1, addr.ADDRESS_LINE_2, addr.ADDRESS_LINE_3,
        addr.ADDRESS_TYPE, addr.CITY as ADDRESS_CITY, addr.COMMENT as ADDRESS_COMMENT, addr.COUNTRY as ADDRESS_COUNTRY, 
        addr.CREATE_DATE as ADDRESS_CREATE_DATE, addr.EFFECTIVE_DATE as ADDRESS_EFFECTIVE_DATE, addr.INACTIVE as ADDRESS_INACTIVE, 
        addr.POSTAL_CODE as ADDRESS_POSTAL_CODE, addr.RECEIVE_CORRESPONDENCE as ADDRESS_RECEIVE_CORRESPONDENCE, addr.SEASONAL_END_DATE as ADDRESS_SEASONAL_END_DATE, 
        addr.SEASONAL_START_DATE as ADDRESS_SEASONAL_START_DATE, addr.STATE_PROVINCE as ADDRESS_STATE_PROVINCE,
        addr.TEMPORARY_END_DATE as ADDRESS_TEMPORARY_END_DATE, addr.TEMPORARY_START_DATE as ADDRESS_TEMPORARY_START_DATE, 
        addr.UPDATE_DATE as ADDRESS_UPDATE_DATE, addr.CONSTITUENT_ID as ADDRESS_CONSTITUENT_ID, addr.IS_PRIMARY as ADDRESS_IS_PRIMARY
    </sql>

    <sql id="SELECT_ADDRESS_FRAGMENT">
        select 
        <include refid="ADDRESS_COLS_FRAGMENT"/>
        from ADDRESS addr 
    </sql>

    <select id="SELECT_ADDRESS_BY_ID" resultMap="ADDRESS_RESULT" parameterClass="long">
        <include refid="SELECT_ADDRESS_FRAGMENT"/>
        where addr.ADDRESS_ID = #value#
    </select>

    <select id="SELECT_ALL_ADDRESSES_BY_CONSTITUENT_ID" resultMap="ADDRESS_RESULT" parameterClass="long">
        <include refid="SELECT_ADDRESS_FRAGMENT"/>
        where addr.CONSTITUENT_ID = #value#
    </select>
	
	<select id="SELECT_ACTIVE_ADDRESSES_BY_CONSTITUENT_ID" resultMap="ADDRESS_RESULT" parameterClass="long">
		<include refid="SELECT_ADDRESS_FRAGMENT"/>
		where addr.CONSTITUENT_ID = #id#
		and addr.INACTIVE = false
		order by ADDRESS_TYPE, ADDRESS_ACTIVATION_STATUS
	</select>

<!-- 
    <select id="SELECT_BY_CURRENT_ADDRESS" resultMap="ADDRESS_RESULT" parameterClass="map">
        <include refid="SELECT_ADDRESS_FRAGMENT"/>
        where CONSTITUENT_ID = #personId#
        and RECEIVE_CORRESPONDENCE = #mailOnly#
        and INACTIVE = false
        and ACTIVATION_STATUS = 'temporary'
        and TEMPORARY_START_DATE &lt;= #effectiveDate#
        and TEMPORARY_END_DATE &gt;= #effectiveDate#
        UNION
        <include refid="SELECT_ADDRESS_FRAGMENT"/>
        where CONSTITUENT_ID = #personId#
        and RECEIVE_CORRESPONDENCE = #mailOnly#
        and INACTIVE = false
        and ACTIVATION_STATUS = 'seasonal'
        and ((year(seasonal_start_date) &lt; year(seasonal_end_date)
            and( (dayofyear(#effectiveDate#) &gt;= dayofyear(seasonal_start_date)
                    and dayofyear(#effectiveDate#) &lt;= dayofyear(seasonal_end_date)+365)
                or( dayofyear(#effectiveDate#) + 365 &gt;= dayofyear(seasonal_start_date)
                    and dayofyear(#effectiveDate#) + 365 &lt;= dayofyear(seasonal_end_date)+365)))
        or (year(seasonal_end_date) = year(seasonal_end_date)
            and dayofyear(#effectiveDate#) &gt;= dayofyear(seasonal_start_date)
            and dayofyear(#effectiveDate#) &lt;= dayofyear(seasonal_end_date)))
        UNION
        <include refid="SELECT_ADDRESS_FRAGMENT"/>
        where CONSTITUENT_ID = #personId#
        and RECEIVE_CORRESPONDENCE = #mailOnly#
        and INACTIVE = false
        and ACTIVATION_STATUS = 'permanent'
        and EFFECTIVE_DATE &lt;= #effectiveDate#
    </select>
 -->
 
    <insert id="INSERT_ADDRESS" parameterClass="com.mpower.domain.model.communication.Address">
        insert into ADDRESS (ACTIVATION_STATUS, ADDRESS_LINE_1, ADDRESS_LINE_2,
        ADDRESS_LINE_3, ADDRESS_TYPE, CITY, COMMENT, COUNTRY, CREATE_DATE, EFFECTIVE_DATE, INACTIVE,
        POSTAL_CODE, RECEIVE_CORRESPONDENCE, SEASONAL_END_DATE, SEASONAL_START_DATE, STATE_PROVINCE,
        TEMPORARY_END_DATE, TEMPORARY_START_DATE, UPDATE_DATE, CONSTITUENT_ID, IS_PRIMARY)
        values (#activationStatus#, #addressLine1#,
        #addressLine2#, #addressLine3#, #addressType#, #city#,
        #comments#, #country#, now(), #effectiveDate#,
        #inactive#, #postalCode#, #receiveMail#,
        #seasonalEndDate#, #seasonalStartDate#, #stateProvince#,
        #temporaryEndDate#, #temporaryStartDate#, now(),
        #personId#, #primary#)
        <selectKey keyProperty="id" resultClass="long">
            SELECT LAST_INSERT_ID() AS value
        </selectKey>
    </insert>

    <update id="UPDATE_ADDRESS" parameterClass="com.mpower.domain.model.communication.Address">
        update ADDRESS
        SET UPDATE_DATE = now(),
        ACTIVATION_STATUS = #activationStatus#,
        ADDRESS_LINE_1 = #addressLine1#,
        ADDRESS_LINE_2 = #addressLine2#,
        ADDRESS_LINE_3 = #addressLine3#,
        ADDRESS_TYPE = #addressType#,
        CITY = #city#,
        COMMENT = #comments#,
        COUNTRY = #country#,
        EFFECTIVE_DATE = #effectiveDate#,
        INACTIVE = #inactive#,
        POSTAL_CODE = #postalCode#,
        RECEIVE_CORRESPONDENCE = #receiveMail#,
        SEASONAL_END_DATE = #seasonalEndDate#,
        SEASONAL_START_DATE = #seasonalStartDate#,
        STATE_PROVINCE = #stateProvince#,
        TEMPORARY_END_DATE = #temporaryEndDate#,
        TEMPORARY_START_DATE = #temporaryStartDate#,
        CONSTITUENT_ID = #personId#,
		IS_PRIMARY = #primary#
        where ADDRESS_ID = #id#
    </update>

    <update id="INACTIVATE_ADDRESSES">
        update ADDRESS
        set INACTIVE = true
        where ACTIVATION_STATUS = 'temporary'
        and INACTIVE = false
        and TEMPORARY_END_DATE &lt;= now()
    </update>    

</sqlMap>