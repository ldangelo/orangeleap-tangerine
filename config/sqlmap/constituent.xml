<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="CONSTITUENT">

	<resultMap id="CONSTITUENT_RESULT" class="com.mpower.domain.model.Person" groupBy="id">
		<result property="id" column="PERSON_ID" jdbcType="BIGINT" />
		<result property="constituentIndividualRoles" column="CONSTITUENT_INDIVIDUAL_ROLES" jdbcType="VARCHAR" />
		<result property="constituentOrganizationRoles" column="CONSTITUENT_ORGANIZATION_ROLES" jdbcType="VARCHAR" />
		<result property="constituentType" column="CONSTITUENT_TYPE" jdbcType="VARCHAR" />
		<result property="createDate" column="CREATE_DATE" jdbcType="TIMESTAMP" />
		<result property="firstName" column="FIRST_NAME" jdbcType="VARCHAR" />
		<result property="lapsedDonor" column="LAPSED_DONOR" jdbcType="CHAR" />
		<result property="lastName" column="LAST_NAME" jdbcType="VARCHAR" />
		<result property="legalName" column="LEGAL_NAME" jdbcType="VARCHAR" />
		<result property="loginId" column="LOGIN_ID" jdbcType="VARCHAR" />
		<result property="majorDonor" column="MAJOR_DONOR" jdbcType="CHAR" />
		<result property="maritalStatus" column="MARITAL_STATUS" jdbcType="VARCHAR" />
		<result property="middleName" column="MIDDLE_NAME" jdbcType="VARCHAR" />
		<result property="ncaisCode" column="NCAIS_CODE" jdbcType="VARCHAR" />
		<result property="organizationName" column="ORGANIZATION_NAME" jdbcType="VARCHAR" />
		<result property="preferredPhoneType" column="PREFERRED_PHONE_TYPE" jdbcType="VARCHAR" />
		<result property="recognitionName" column="RECOGNITION_NAME" jdbcType="VARCHAR" />
		<result property="suffix" column="SUFFIX" jdbcType="VARCHAR" />
		<result property="title" column="TITLE" jdbcType="VARCHAR" />
		<result property="updateDate" column="UPDATE_DATE" jdbcType="TIMESTAMP" />
		<result property="site" resultMap="SITE.SITE_NAME_RESULT" />
		<!-- 
		<result property="personCustomFields" resultMap="CONSTITUENT_CUSTOM_FIELD.CONSTITUENT_CUSTOM_FIELD_RESULT" /> 
		-->
	</resultMap>

    <sql id="CONSTITUENT_COLS_FRAGMENT">
    	p.PERSON_ID, p.CONSTITUENT_INDIVIDUAL_ROLES,
		p.CONSTITUENT_ORGANIZATION_ROLES, p.CONSTITUENT_TYPE, p.CREATE_DATE, p.FIRST_NAME, p.LAPSED_DONOR, p.LAST_NAME, p.LEGAL_NAME,
		p.LOGIN_ID, p.MAJOR_DONOR, p.MARITAL_STATUS, p.MIDDLE_NAME, p.NCAIS_CODE, p.ORGANIZATION_NAME,
		p.PREFERRED_PHONE_TYPE, p.RECOGNITION_NAME, p.SUFFIX, p.TITLE, p.UPDATE_DATE, p.SITE_NAME
    </sql>
    
	<sql id="SELECT_CONSTITUENT_FRAGMENT">
		select 
        <include refid="CONSTITUENT_COLS_FRAGMENT"/>
		<!-- 
		pcf.PERSON_CUSTOM_FIELD_ID, pcf.PERSON_ID as CONS_CUS_FLD_PERSON_ID,
		 
		cf.CUSTOM_FIELD_ID, cf.FIELD_NAME as CUS_FLD_FIELD_NAME, cf.FIELD_VALUE as CUS_FLD_FIELD_VALUE
		 -->
		from PERSON p
		<!-- 
		left outer join PERSON_CUSTOM_FIELD pcf on p.PERSON_ID = pcf.PERSON_ID 
		left outer join CUSTOM_FIELD cf on pcf.CUSTOM_FIELD_ID = cf.CUSTOM_FIELD_ID
		 -->  
	</sql>
	
	<select id="SELECT_CONSTITUENT_BY_IDS_SITE" resultMap="CONSTITUENT_RESULT" parameterClass="map">
		<include refid="SELECT_CONSTITUENT_FRAGMENT"/>		 
		where p.PERSON_ID in 
		<iterate property="personIds" conjunction="," open="(" close=")">
			#personIds[]#
		</iterate>
		and p.SITE_NAME = #siteName#
	</select>
	
	<select id="SELECT_ALL_CONSTITUENTS_BY_SITE" resultMap="CONSTITUENT_RESULT" parameterClass="string">
		<include refid="SELECT_CONSTITUENT_FRAGMENT"/>		 
		where p.SITE_NAME = #siteName#
	</select>

	<select id="SELECT_CONSTITUENT_BY_LOGIN_ID_SITE" resultMap="CONSTITUENT_RESULT" parameterClass="map">
		<include refid="SELECT_CONSTITUENT_FRAGMENT"/>		 
		where p.LOGIN_ID = #loginId#
		and p.SITE_NAME = #siteName#
	</select>

	<insert id="INSERT_CONSTITUENT" parameterClass="com.mpower.domain.model.Person">
		insert into PERSON (CONSTITUENT_INDIVIDUAL_ROLES,
		CONSTITUENT_ORGANIZATION_ROLES,	CONSTITUENT_TYPE, FIRST_NAME, LAPSED_DONOR, LAST_NAME, LEGAL_NAME,
		LOGIN_ID, MAJOR_DONOR, MARITAL_STATUS, MIDDLE_NAME, NCAIS_CODE, ORGANIZATION_NAME,
		PREFERRED_PHONE_TYPE, RECOGNITION_NAME, SUFFIX, TITLE, CREATE_DATE, UPDATE_DATE, SITE_NAME)
		values (#constituentIndividualRoles#,
		#constituentOrganizationRoles#, #constituentType#, #firstName#, #lapsedDonor#, #lastName#, #legalName#,
		#loginId#, #majorDonor#, #maritalStatus#, #middleName#,	#ncaisCode#, #organizationName#, 
		#preferredPhoneType#, #recognitionName#, #suffix#, #title#, now(), now(), #site.name#)
		<selectKey keyProperty="id" resultClass="long">
			SELECT LAST_INSERT_ID() AS value
		</selectKey>
	</insert>

	<update id="UPDATE_CONSTITUENT" parameterClass="com.mpower.domain.model.Person">
		update PERSON
		set CONSTITUENT_INDIVIDUAL_ROLES = #constituentIndividualRoles#,
		CONSTITUENT_ORGANIZATION_ROLES = #constituentOrganizationRoles#,
		CONSTITUENT_TYPE = #constituentType#,
		FIRST_NAME = #firstName#,
		LAPSED_DONOR = #lapsedDonor#,
		LAST_NAME = #lastName#,
		LEGAL_NAME = #legalName#,
		LOGIN_ID = #loginId#,
		MAJOR_DONOR = #majorDonor#,
		MARITAL_STATUS = #maritalStatus#,
		MIDDLE_NAME = #middleName#,
		NCAIS_CODE = #ncaisCode#,
		ORGANIZATION_NAME = #organizationName#,
		PREFERRED_PHONE_TYPE = #preferredPhoneType#,
		RECOGNITION_NAME = #recognitionName#,
		SUFFIX = #suffix#,
		TITLE = #title#,
		UPDATE_DATE = now(),
		SITE_NAME = #site.name#
		where PERSON_ID = #id#
	</update>

	<update id="SET_LAPSED_DONOR" parameterClass="long">
		update PERSON
		set LAPSED_DONOR = TRUE
		where PERSON_ID = #id#
	</update>
	
	<statement id="SELECT_CONSTITUENT_BY_SEARCH_TERMS" resultMap="CONSTITUENT_RESULT" parameterClass="map">
	    select
		<include refid="CONSTITUENT_COLS_FRAGMENT"/>		 
		from PERSON p
		where 
		p.SITE_NAME = #siteName#
		<isNotNull property="ignoreIds"> 
	       and p.PERSON_ID not in 
		   <iterate property="ignoreIds" conjunction="," open="(" close=")">
		      #ignoreIds[]#
		   </iterate>
		</isNotNull>
		<isNotNull property="stringParams"> 
		   <iterate property="stringParams" conjunction="and" open="and" close="">
		   p.$stringParams[].key$ like #stringParams[].value#
		   </iterate>
		</isNotNull>
		<isNotNull property="nonStringParams"> 
		   <iterate property="nonStringParams" conjunction="and" open="and" close="">
		   p.$nonStringParams[].key$ = #nonStringParams[].value#
		   </iterate>
		</isNotNull>
		<isNotNull property="phoneParams"> 
		   and exists (
		    select * from PHONE ph where 
		    ph.PERSON_ID = p.PERSON_ID
		    <iterate property="phoneParams" conjunction="and" open="and" close="">
		    ph.$phoneParams[].key$ like #phoneParams[].value#
		    </iterate>
		   )
		</isNotNull>
		<isNotNull property="addressParams"> 
		   and exists (
		    select * from ADDRESS addr where 
		    addr.PERSON_ID = p.PERSON_ID
		    <iterate property="addressParams" conjunction="and" open="and" close="">
		    addr.$addressParams[].key$ like #addressParams[].value#
		    </iterate>
		   )
		</isNotNull>
		<isNotNull property="emailParams"> 
		   and exists (
		    select * from EMAIL e where 
		    e.PERSON_ID = p.PERSON_ID
		    <iterate property="emailParams" conjunction="and" open="and" close="">
		    e.$emailParams[].key$ like #emailParams[].value#
		    </iterate>
		   )
		</isNotNull>
		<!--  TODO  -->
		<isNotNull property="customParams"> 
		   and exists (
		    select * from CUSTOM_FIELD cf where 
		    cf.ENTITY_ID = p.PERSON_ID
		    and cf.ENTITY_TYPE = 'person'
		    <iterate property="customParams" conjunction="and" open="and" close="">
		    cf.FIELD_NAME = #customParams[].key# and cf.FIELD_VALUE like #customParams[].value#
		    </iterate>
		   )
		</isNotNull>
		
		
	</statement>
	
	

</sqlMap>