<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="EMAIL">

	<resultMap id="EMAIL_RESULT" class="com.mpower.domain.model.communication.Email">
		<result property="id" column="EMAIL_ID" jdbcType="BIGINT" />
		<result property="activationStatus" column="EMAIL_ACTIVATION_STATUS" jdbcType="VARCHAR" />
		<result property="comments" column="EMAIL_COMMENT" jdbcType="VARCHAR" />
		<result property="createDate" column="EMAIL_CREATE_DATE" jdbcType="TIMESTAMP" />
		<result property="effectiveDate" column="EMAIL_EFFECTIVE_DATE" jdbcType="TIMESTAMP" />
		<result property="emailAddress" column="EMAIL_ADDRESS" jdbcType="VARCHAR" />
		<result property="emailDisplay" column="EMAIL_DISPLAY" jdbcType="VARCHAR" />
		<result property="emailType" column="EMAIL_TYPE" jdbcType="VARCHAR" />
		<result property="inactive" column="EMAIL_INACTIVE" jdbcType="CHAR" />
		<result property="receiveMail" column="EMAIL_RECEIVE_CORRESPONDENCE" jdbcType="CHAR" />
		<result property="seasonalEndDate" column="EMAIL_SEASONAL_END_DATE" jdbcType="TIMESTAMP" />
		<result property="seasonalStartDate" column="EMAIL_SEASONAL_START_DATE" jdbcType="TIMESTAMP" />
		<result property="temporaryEndDate" column="EMAIL_TEMPORARY_END_DATE"	jdbcType="TIMESTAMP" />
		<result property="temporaryStartDate" column="EMAIL_TEMPORARY_START_DATE"	jdbcType="TIMESTAMP" />
		<result property="updateDate" column="EMAIL_UPDATE_DATE" jdbcType="TIMESTAMP" />
		<result property="personId" column="EMAIL_CONSTITUENT_ID" jdbcType="BIGINT" />
		<result property="primary" column="EMAIL_IS_PRIMARY" jdbcType="CHAR" />
	</resultMap>

    <sql id="EMAIL_COLS_FRAGMENT">
    	e.EMAIL_ID, e.ACTIVATION_STATUS as EMAIL_ACTIVATION_STATUS, e.COMMENT as EMAIL_COMMENT, e.CREATE_DATE as EMAIL_CREATE_DATE, e.EFFECTIVE_DATE as EMAIL_EFFECTIVE_DATE,
		e.EMAIL_ADDRESS, e.EMAIL_DISPLAY, e.EMAIL_TYPE, e.INACTIVE as EMAIL_INACTIVE, e.RECEIVE_CORRESPONDENCE as EMAIL_RECEIVE_CORRESPONDENCE, e.SEASONAL_END_DATE as EMAIL_SEASONAL_END_DATE,
		e.SEASONAL_START_DATE as EMAIL_SEASONAL_START_DATE, e.TEMPORARY_END_DATE as EMAIL_TEMPORARY_END_DATE, e.TEMPORARY_START_DATE as EMAIL_TEMPORARY_START_DATE,
		e.UPDATE_DATE as EMAIL_UPDATE_DATE, e.CONSTITUENT_ID as EMAIL_CONSTITUENT_ID, e.IS_PRIMARY as EMAIL_IS_PRIMARY
	</sql>
	
	<sql id="SELECT_EMAIL_FRAGMENT">
		select 
        <include refid="EMAIL_COLS_FRAGMENT"/>
		from EMAIL e
        inner join CONSTITUENT p ON e.CONSTITUENT_ID = p.CONSTITUENT_ID 
        where p.SITE_NAME = #siteName# 
	</sql>
	
	<select id="SELECT_EMAIL_BY_EMAIL_ID" resultMap="EMAIL_RESULT"	parameterClass="map">
		<include refid="SELECT_EMAIL_FRAGMENT"/>
		and e.EMAIL_ID = #emailId#
	</select>
	
	<select id="SELECT_ALL_EMAILS_BY_CONSTITUENT_ID" resultMap="EMAIL_RESULT" parameterClass="map">
		<include refid="SELECT_EMAIL_FRAGMENT"/>
		and e.CONSTITUENT_ID = #constituentId#
	</select>

	<select id="SELECT_ACTIVE_EMAILS_BY_CONSTITUENT_ID" resultMap="EMAIL_RESULT" parameterClass="map">
		<include refid="SELECT_EMAIL_FRAGMENT"/>
		and e.CONSTITUENT_ID = #constituentId#
		and e.INACTIVE = false
		order by EMAIL_TYPE, EMAIL_ACTIVATION_STATUS
	</select>

	<insert id="INSERT_EMAIL" parameterClass="com.mpower.domain.model.communication.Email">
		insert into EMAIL (ACTIVATION_STATUS, COMMENT, CREATE_DATE, EFFECTIVE_DATE,
		EMAIL_ADDRESS, EMAIL_DISPLAY, EMAIL_TYPE, INACTIVE, RECEIVE_CORRESPONDENCE,
		SEASONAL_END_DATE, SEASONAL_START_DATE, TEMPORARY_END_DATE, TEMPORARY_START_DATE, UPDATE_DATE, CONSTITUENT_ID, IS_PRIMARY)
		values (#activationStatus#, #comments#, now(), #effectiveDate#, #emailAddress#, #emailDisplay#,
		#emailType#, #inactive#, #receiveMail#, #seasonalEndDate#,
		#seasonalStartDate#, #temporaryEndDate#, #temporaryStartDate#,
		now(), #personId#, #primary#)
		<selectKey keyProperty="id" resultClass="long">
			SELECT LAST_INSERT_ID() AS value
		</selectKey>
	</insert>

	<update id="UPDATE_EMAIL" parameterClass="com.mpower.domain.model.communication.Email">
		update EMAIL
		set ACTIVATION_STATUS = #activationStatus#,
		COMMENT = #comments#,
		EFFECTIVE_DATE = #effectiveDate#,
		EMAIL_ADDRESS = #emailAddress#,
		EMAIL_DISPLAY = #emailDisplay#,
		EMAIL_TYPE = #emailType#,
		INACTIVE = #inactive#,
		RECEIVE_CORRESPONDENCE = #receiveMail#,
		SEASONAL_END_DATE = #seasonalEndDate#,
		SEASONAL_START_DATE = #seasonalStartDate#,
		TEMPORARY_END_DATE = #temporaryEndDate#,
		TEMPORARY_START_DATE = #temporaryStartDate#,
		UPDATE_DATE = now(),
		CONSTITUENT_ID = #personId#,
		IS_PRIMARY = #primary#
		where EMAIL_ID = #id#
	</update>
		
	<update id="INACTIVATE_EMAILS">
		update EMAIL
		set INACTIVE = true
		where ACTIVATION_STATUS = 'temporary' 
		and INACTIVE = false
		and TEMPORARY_END_DATE &lt;= now()
	</update>
	
</sqlMap>