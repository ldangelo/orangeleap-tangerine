<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="GIFT">

	<resultMap id="GIFT_RESULT_NO_DISTRO_LINES" class="com.mpower.domain.model.paymentInfo.Gift" groupBy="id">
		<result property="id" column="GIFT_ID" jdbcType="BIGINT" />
		<result property="acknowledgmentDate" column="GIFT_ACKNOWLEDGMENT_DATE" jdbcType="TIMESTAMP" />
		<result property="amount" column="GIFT_AMOUNT" jdbcType="DECIMAL" />
		<result property="authCode" column="GIFT_AUTH_CODE" jdbcType="VARCHAR" />
		<result property="checkNumber" column="GIFT_CHECK_NUMBER" jdbcType="INTEGER" />
		<result property="comments" column="GIFT_COMMENTS" jdbcType="VARCHAR" />
		<result property="currencyCode" column="GIFT_CURRENCY_CODE" jdbcType="VARCHAR" />
		<result property="deductible" column="GIFT_DEDUCTIBLE" jdbcType="CHAR" />
		<result property="deductibleAmount" column="GIFT_DEDUCTIBLE_AMOUNT" jdbcType="DECIMAL" />
		<result property="donationDate" column="GIFT_DONATION_DATE" jdbcType="TIMESTAMP" />
		<result property="entryType" column="GIFT_ENTRY_TYPE" jdbcType="VARCHAR" />
		<result property="originalGiftId" column="ORIGINAL_GIFT_ID" jdbcType="BIGINT" />
		<result property="paymentMessage" column="GIFT_PAYMENT_MESSAGE" jdbcType="VARCHAR" />
		<result property="paymentStatus" column="GIFT_PAYMENT_STATUS" jdbcType="VARCHAR" />
		<result property="paymentType" column="GIFT_PAYMENT_TYPE" jdbcType="VARCHAR" />
		<result property="postmarkDate" column="GIFT_POSTMARK_DATE" jdbcType="TIMESTAMP" />
		<result property="refundGiftId" column="REFUND_GIFT_ID" jdbcType="BIGINT" />
		<result property="refundGiftTransactionDate" column="REFUND_GIFT_TRANSACTION_DATE" jdbcType="TIMESTAMP" />
		<result property="sendAcknowledgment" column="GIFT_SEND_ACKNOWLEDGMENT" jdbcType="CHAR" />
		<result property="transactionDate" column="GIFT_TRANSACTION_DATE" jdbcType="TIMESTAMP" />
		<result property="txRefNum" column="GIFT_PAYMENT_TXREFNUM" jdbcType="VARCHAR" />
		<result property="commitmentId" column="GIFT_COMMITMENT_ID" jdbcType="BIGINT" />
		<result property="person" resultMap="CONSTITUENT.CONSTITUENT_RESULT" />
		<result property="address" resultMap="ADDRESS.ADDRESS_RESULT" />
		<result property="phone" resultMap="PHONE.PHONE_RESULT" />
		<result property="email" resultMap="EMAIL.EMAIL_RESULT" />
		<result property="paymentSource" resultMap="PAYMENT_SOURCE.PAYMENT_SOURCE_RESULT" />
	</resultMap>
	
	<resultMap id="GIFT_RESULT" class="com.mpower.domain.model.paymentInfo.Gift" groupBy="id" extends="GIFT_RESULT_NO_DISTRO_LINES">
		<result property="distributionLines" resultMap="DISTRO_LINE.DISTRO_LINE_RESULT" />
	</resultMap>

	<sql id="GIFT_COLS_FRAGMENT">
		g.GIFT_ID, g.ACKNOWLEDGMENT_DATE as GIFT_ACKNOWLEDGMENT_DATE, g.AMOUNT as GIFT_AMOUNT, g.AUTH_CODE as GIFT_AUTH_CODE, g.CHECK_NUMBER as GIFT_CHECK_NUMBER,
		g.COMMENTS as GIFT_COMMENTS, g.CURRENCY_CODE as GIFT_CURRENCY_CODE,
		g.DEDUCTIBLE as GIFT_DEDUCTIBLE, g.DEDUCTIBLE_AMOUNT as GIFT_DEDUCTIBLE_AMOUNT, g.DONATION_DATE as GIFT_DONATION_DATE, g.ENTRY_TYPE as GIFT_ENTRY_TYPE,
		g.ORIGINAL_GIFT_ID, g.PAYMENT_MESSAGE as GIFT_PAYMENT_MESSAGE,
		g.PAYMENT_STATUS as GIFT_PAYMENT_STATUS, g.PAYMENT_TYPE as GIFT_PAYMENT_TYPE, g.POSTMARK_DATE as GIFT_POSTMARK_DATE, g.REFUND_GIFT_ID,
		g.REFUND_GIFT_TRANSACTION_DATE,
		g.SEND_ACKNOWLEDGMENT as GIFT_SEND_ACKNOWLEDGMENT, g.TRANSACTION_DATE as GIFT_TRANSACTION_DATE, g.PAYMENT_TXREFNUM as GIFT_PAYMENT_TXREFNUM, 
		g.COMMITMENT_ID as GIFT_COMMITMENT_ID 
	</sql>
	
	<sql id="GIFT_COLS_CHILD_IDS_FRAGMENT">
		<include refid="GIFT_COLS_FRAGMENT"/>,
		g.PERSON_ID, g.ADDRESS_ID, g.PHONE_ID, g.EMAIL_ID, g.PAYMENT_SOURCE_ID
	</sql>

	<sql id="GIFT_QUERY_FRAGMENT">
		select
		<include refid="GIFT_COLS_FRAGMENT" />,
		<include refid="CONSTITUENT_COLS_FRAGMENT" />,
		<include refid="ADDRESS_COLS_FRAGMENT" />,
		<include refid="PHONE_COLS_FRAGMENT" />,
		<include refid="EMAIL_COLS_FRAGMENT" />,
		<include refid="PAYMENT_SRC_COLS_FRAGMENT" />,
		<include refid="DISTRO_LINE_COLS_FRAGMENT" />
		from GIFT g
		inner join PERSON p on g.PERSON_ID = p.PERSON_ID
		left outer join EMAIL e on g.EMAIL_ID = e.EMAIL_ID
		left outer join PHONE ph on g.PHONE_ID = ph.PHONE_ID
		left outer join ADDRESS addr on g.ADDRESS_ID = addr.ADDRESS_ID
		left outer join PAYMENT_SOURCE ps on g.PAYMENT_SOURCE_ID = ps.PAYMENT_SOURCE_ID
		left outer join DISTRO_LINE dl on g.GIFT_ID = dl.GIFT_ID
		where p.SITE_NAME = #siteName#
	</sql>

	<select id="SELECT_GIFT_BY_ID" resultMap="GIFT_RESULT" parameterClass="map">
		<include refid="GIFT_QUERY_FRAGMENT" />
		and g.GIFT_ID = #id#
	</select>

	<select id="SELECT_ALL_GIFTS_BY_SITE" resultMap="GIFT_RESULT" parameterClass="map">
		<include refid="GIFT_QUERY_FRAGMENT" />
	</select>

	<select id="SELECT_GIFTS_BY_CONSTITUENT_ID" resultMap="GIFT_RESULT" parameterClass="map">
		<include refid="GIFT_QUERY_FRAGMENT" />
		and g.PERSON_ID = #constituentId#
		order by g.TRANSACTION_DATE desc
	</select>

	<select id="SELECT_GIFTS_BY_COMMITMENT_ID" resultMap="GIFT_RESULT" parameterClass="map">
		<include refid="GIFT_QUERY_FRAGMENT" />
		and g.COMMITMENT_ID = #commitmentId#
		order by g.TRANSACTION_DATE desc
	</select>

	<select id="READ_GIFTS_RECEIVED_SUM_BY_COMMITMENT_ID" parameterClass="map" resultClass="decimal">
		select SUM(g.AMOUNT)
		from GIFT g
		inner join PERSON p on g.PERSON_ID = p.PERSON_ID
		where p.SITE_NAME = #siteName#
		and g.COMMITMENT_ID = #commitmentId#
	</select>

	<select id="ANALYZE_FOR_MAJOR_DONOR" parameterClass="map" resultClass="decimal">
		select SUM(g.AMOUNT)
		from GIFT g
		inner join PERSON p on g.PERSON_ID = p.PERSON_ID
		where p.SITE_NAME = #siteName#
		and g.PERSON_ID = #constituentId#
		and g.TRANSACTION_DATE between #beginDate# and #currentDate#
	</select>

	<select id="ANALYZE_FOR_LAPSED_DONOR" parameterClass="map" resultMap="CONSTITUENT.CONSTITUENT_RESULT">
		select 
		<include refid="CONSTITUENT_COLS_FRAGMENT" />
		from PERSON p 
		inner join GIFT g on p.PERSON_ID = g.PERSON_ID
		where g.AMOUNT > 0 
		and (g.TRANSACTION_DATE between #beginDate# and #currentDate#)
	</select>

	<insert id="INSERT_GIFT" parameterClass="com.mpower.domain.model.paymentInfo.Gift">
		insert into GIFT (ACKNOWLEDGMENT_DATE, AMOUNT, AUTH_CODE,
		CHECK_NUMBER, COMMENTS,
		CURRENCY_CODE, DEDUCTIBLE, DEDUCTIBLE_AMOUNT, DONATION_DATE, ENTRY_TYPE,
		ORIGINAL_GIFT_ID,
		PAYMENT_MESSAGE, PAYMENT_STATUS, PAYMENT_TYPE, POSTMARK_DATE, REFUND_GIFT_ID,
		REFUND_GIFT_TRANSACTION_DATE, SEND_ACKNOWLEDGMENT, TRANSACTION_DATE,
		PAYMENT_TXREFNUM,
		ADDRESS_ID, COMMITMENT_ID, EMAIL_ID, PAYMENT_SOURCE_ID, PERSON_ID, PHONE_ID)
		values (#acknowledgmentDate#, #amount#, #authCode#,
		#checkNumber#, #comments#, #currencyCode#, #deductible#,
		#deductibleAmount#, #donationDate#, #entryType#,
		#originalGiftId#, #paymentMessage#, #paymentStatus#,
		#paymentType#, #postmarkDate#, #refundGiftId#,
		#refundGiftTransactionDate#, #sendAcknowledgment#, #transactionDate#,
		#txRefNum#, #address.id#, #commitmentId#, #email.id#,
		#paymentSource.id#, #person.id#, #phone.id#)
		<selectKey keyProperty="id" resultClass="long">
			SELECT LAST_INSERT_ID() AS value
		</selectKey>
	</insert>
	
	<update id="UPDATE_GIFT" parameterClass="com.mpower.domain.model.paymentInfo.Gift">
		update GIFT
		set ACKNOWLEDGMENT_DATE = #acknowledgmentDate#,
		AMOUNT = #amount#,
		AUTH_CODE = #authCode#,
		CHECK_NUMBER = #checkNumber#,
		COMMENTS = #comments#,
		CURRENCY_CODE = #currencyCode#,
		DEDUCTIBLE = #deductible#,
		DEDUCTIBLE_AMOUNT = #deductibleAmount#,
		DONATION_DATE = #donationDate#,
		ENTRY_TYPE = #entryType#,
		ORIGINAL_GIFT_ID = #originalGiftId#,
		PAYMENT_MESSAGE = #paymentMessage#,
		PAYMENT_STATUS = #paymentStatus#,
		PAYMENT_TYPE = #paymentType#,
		POSTMARK_DATE = #postmarkDate#,
		REFUND_GIFT_ID = #refundGiftId#,
		REFUND_GIFT_TRANSACTION_DATE = #refundGiftTransactionDate#,
		SEND_ACKNOWLEDGMENT = #sendAcknowledgment#,
		TRANSACTION_DATE = #transactionDate#,
		PAYMENT_TXREFNUM = #txRefNum#,
		ADDRESS_ID = #address.id#,
		COMMITMENT_ID = #commitmentId#,
		EMAIL_ID = #email.id#,
		PAYMENT_SOURCE_ID = #paymentSource.id#,
		PERSON_ID = #person.id#,
		PHONE_ID = #phone.id#
		where GIFT_ID = #id#
	</update>
	
	
	<statement id="SELECT_GIFT_BY_SEARCH_TERMS" resultMap="GIFT_RESULT" parameterClass="map">
	    select
		<include refid="GIFT_COLS_FRAGMENT"/>,	 
		<include refid="PERSON_COLS_FRAGMENT"/>		 
		from GIFT g
		inner join PERSON p on g.PERSON_ID = p.PERSON_ID
		where 
		p.SITE_NAME = #siteName#
		<isNotNull property="stringParams"> 
		   <iterate property="stringParams" conjunction="and" open="and" close="">
		   p.$stringParams[].key$ like #stringParams[].value#
		   </iterate>
		</isNotNull>
		<isNotNull property="nonStringParams"> 
		   <iterate property="nonStringParams" conjunction="and" open="and" close="">
		   p.$nonStringParams[].key$ = #nonStringParams[].value#
		   </iterate>
		</isNotNull>
		<isNotNull property="phoneParams"> 
		   and exists (
		    select * from PHONE ph where 
		    ph.PERSON_ID = p.PERSON_ID
		    <iterate property="phoneParams" conjunction="and" open="and" close="">
		    ph.$phoneParams[].key$ like #phoneParams[].value#
		    </iterate>
		   )
		</isNotNull>
		<isNotNull property="addressParams"> 
		   and exists (
		    select * from ADDRESS addr where 
		    addr.PERSON_ID = p.PERSON_ID
		    <iterate property="addressParams" conjunction="and" open="and" close="">
		    addr.$addressParams[].key$ like #addressParams[].value#
		    </iterate>
		   )
		</isNotNull>
		<isNotNull property="emailParams"> 
		   and exists (
		    select * from EMAIL e where 
		    e.PERSON_ID = p.PERSON_ID
		    <iterate property="emailParams" conjunction="and" open="and" close="">
		    e.$emailParams[].key$ like #emailParams[].value#
		    </iterate>
		   )
		</isNotNull>
		<isNotNull property="customParams"> 
		   and exists (
		    select * from CUSTOM_FIELD cf where 
		   ((cf.ENTITY_ID = p.GIFT_ID and cf.ENTITY_TYPE = 'gift') or (cf.ENTITY_ID = p.PERSON_ID and cf.ENTITY_TYPE = 'person'))
		    <iterate property="customParams" conjunction="and" open="and" close="">
		    cf.FIELD_NAME = #customParams[].key# and cf.FIELD_VALUE like #customParams[].value#
		    </iterate>
		   )
		</isNotNull>
		
		
	</statement>
	
	
	
</sqlMap>