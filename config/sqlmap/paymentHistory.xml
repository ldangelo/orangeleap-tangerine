<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="PAYMENT_HISTORY" >

  <resultMap id="PAYMENT_HISTORY" class="com.mpower.domain.model.PaymentHistory" >
    <result property="id" column="PAYMENT_HISTORY_ID" jdbcType="BIGINT" />
    <result property="amount" column="AMOUNT" jdbcType="DECIMAL" />
    <result property="currencyCode" column="CURRENCY_CODE" jdbcType="VARCHAR" />
    <result property="description" column="PAYMENT_DESC" jdbcType="VARCHAR" />
    <result property="paymentHistoryType" column="PAYMENT_HISTORY_TYPE" jdbcType="VARCHAR" />
    <result property="paymentType" column="PAYMENT_TYPE" jdbcType="VARCHAR" />
    <result property="transactionDate" column="TRANSACTION_DATE" jdbcType="TIMESTAMP" />
    <result property="transactionId" column="TRANSACTION_ID" jdbcType="VARCHAR" />
	<!-- <result property="gift" resultMap="GIFT.GIFT_RESULT" /> -->
	<result property="person" resultMap="CONSTITUENT.CONSTITUENT_RESULT" /> 
  </resultMap>
  
  	<sql id="SELECT_PAYMENT_HISTORY_FRAGMENT">
    select 
      ph.PAYMENT_HISTORY_ID, ph.AMOUNT, ph.CURRENCY_CODE, ph.PAYMENT_DESC, ph.PAYMENT_HISTORY_TYPE,
      ph.PAYMENT_TYPE, ph.TRANSACTION_DATE, ph.TRANSACTION_ID, ph.GIFT_ID,

      <include refid="CONSTITUENT_COLS_FRAGMENT"/>
      
      from PAYMENT_HISTORY ph
      inner join PERSON p on ph.PERSON_ID = p.PERSON_ID
      where 
      p.SITE_NAME= #siteName#
  </sql>
  
  <select id="SELECT_PAYMENT_HISTORY_FOR_PERSON" resultMap="PAYMENT_HISTORY" parameterClass="map" >
	 <include refid="SELECT_PAYMENT_HISTORY_FRAGMENT"/>		 
      and p.PERSON_ID = #personId#
      order by ph.TRANSACTION_DATE desc
  </select>
  
  <select id="SELECT_PAYMENT_HISTORY_FOR_SITE" resultMap="PAYMENT_HISTORY" parameterClass="map" >
	 <include refid="SELECT_PAYMENT_HISTORY_FRAGMENT"/>		 
      order by ph.TRANSACTION_DATE desc
  </select>
  
  <insert id="INSERT_PAYMENT_HISTORY" parameterClass="com.mpower.domain.model.PaymentHistory" >
    insert into PAYMENT_HISTORY (PAYMENT_HISTORY_ID, AMOUNT, CURRENCY_CODE, PAYMENT_DESC,
       PAYMENT_HISTORY_TYPE,  
      PAYMENT_TYPE, TRANSACTION_DATE, TRANSACTION_ID, GIFT_ID, PERSON_ID)
    values (#id#, #amount#, #currencyCode#,#description#, #paymentHistoryType:VARCHAR#, #paymentType#, 
    #transactionDate#, #transactionId#, #gift.id#, #person.id#)
		<selectKey keyProperty="id" resultClass="long">
			SELECT LAST_INSERT_ID() AS value
		</selectKey>
  </insert>
  
</sqlMap>