<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="PICKLIST">

    <cacheModel id="picklist-cache" type="LRU">
        <flushInterval hours="24"/>
        <flushOnExecute statement="UPDATE_PICKLIST"/>
        <flushOnExecute statement="UPDATE_PICKLIST_ITEM"/>
        <flushOnExecute statement="INSERT_PICKLIST"/>
        <flushOnExecute statement="INSERT_PICKLIST_ITEM"/>
        <property name="size" value="1000" />
    </cacheModel>

    <resultMap id="PICKLIST_RESULT" class="com.orangeleap.tangerine.domain.customization.Picklist" groupBy="id">
        <result property="id" column="PICKLIST_ID" jdbcType="VARCHAR"/>
        <result property="picklistDesc" column="PICKLIST_DESC" jdbcType="VARCHAR"/>
        <result property="entityType" column="ENTITY_TYPE" jdbcType="VARCHAR"/>
        <result property="multiselect" column="MULTISELECT" jdbcType="CHAR"/>
        <result property="picklistName" column="PICKLIST_NAME" jdbcType="VARCHAR"/>
        <result property="site" resultMap="SITE.SITE_NAME_RESULT"/>
        <result property="picklistItems" resultMap="PICKLIST.PICKLIST_ITEM_RESULT" />
    </resultMap>

    <resultMap id="PICKLIST_ITEM_RESULT" class="com.orangeleap.tangerine.domain.customization.PicklistItem">
        <result property="id" column="PICKLIST_ITEM_ID" jdbcType="BIGINT"/>
        <result property="picklistId" column="PICKLIST_ID" jdbcType="BIGINT"/>
        <result property="defaultDisplayValue" column="DEFAULT_DISPLAY_VALUE" jdbcType="VARCHAR"/>
		<result property="inactive" column="INACTIVE" jdbcType="CHAR" />
        <result property="itemName" column="ITEM_NAME" jdbcType="VARCHAR"/>
        <result property="itemOrder" column="ITEM_ORDER" jdbcType="INTEGER"/>
        <result property="referenceValue" column="REFERENCE_VALUE" jdbcType="VARCHAR"/>
        <result property="suppressReferenceValue" column="SUPPRESS_REFERENCE_VALUE" jdbcType="VARCHAR"/>
    </resultMap>


    <sql id="SELECT_PICKLIST_FRAGMENT">
        select P.PICKLIST_ID, P.PICKLIST_DESC, P.ENTITY_TYPE, P.MULTISELECT, P.PICKLIST_NAME, P.SITE_NAME,
        I.PICKLIST_ITEM_ID, I.DEFAULT_DISPLAY_VALUE, I.INACTIVE, I.ITEM_NAME, I.ITEM_ORDER,
        I.REFERENCE_VALUE, I.SUPPRESS_REFERENCE_VALUE
        from PICKLIST P 
        left outer join PICKLIST_ITEM I on P.PICKLIST_ID = I.PICKLIST_ID
    </sql>
    
    <sql id="SELECT_PICKLIST_ITEM_FRAGMENT">
        select PICKLIST_ITEM_ID, DEFAULT_DISPLAY_VALUE, INACTIVE, ITEM_NAME, ITEM_ORDER, REFERENCE_VALUE, SUPPRESS_REFERENCE_VALUE, PICKLIST_ID
        from PICKLIST_ITEM
    </sql>

    <select id="SELECT_BY_PICKLIST_ID" resultMap="PICKLIST_RESULT" parameterClass="string" cacheModel="picklist-cache">
        <include refid="SELECT_PICKLIST_FRAGMENT"/>
        where P.PICKLIST_ID = #value#
    </select>

    <select id="SELECT_PICKLIST_BY_SITE_NAME" resultMap="PICKLIST_RESULT" parameterClass="string" cacheModel="picklist-cache">
        <include refid="SELECT_PICKLIST_FRAGMENT"/>
        where ((P.SITE_NAME = #value#) or (P.SITE_NAME is NULL))
        order by SITE_NAME, ENTITY_TYPE, P.PICKLIST_DESC
    </select>

    <select id="SELECT_PICKLIST_BY_SITE_AND_FIELD_NAME" resultMap="PICKLIST_RESULT" parameterClass="map" cacheModel="picklist-cache">
        <include refid="SELECT_PICKLIST_FRAGMENT"/>
        where P.PICKLIST_NAME = #fieldName#
        and ((P.SITE_NAME = #siteName#) or (P.SITE_NAME is NULL))
        and ((P.ENTITY_TYPE = #entityType#) or (P.ENTITY_TYPE is NULL)) 
        order by SITE_NAME, ENTITY_TYPE
    </select>

    <select id="SELECT_PICKLIST_ITEM_BY_ID" resultMap="PICKLIST_ITEM_RESULT" parameterClass="long" cacheModel="picklist-cache">
        <include refid="SELECT_PICKLIST_ITEM_FRAGMENT"/>
        where PICKLIST_ITEM_ID = #id#
    </select>

    <select id="SELECT_PICKLIST_ITEM_BY_PICKLIST_ID_AND_ITEM_NAME" resultMap="PICKLIST_ITEM_RESULT" parameterClass="map" cacheModel="picklist-cache">
        <include refid="SELECT_PICKLIST_ITEM_FRAGMENT"/>
        where PICKLIST_ID = #picklistId#
        and ITEM_NAME = #picklistItemName#
    </select>
    
    <update id="UPDATE_PICKLIST" parameterClass="com.orangeleap.tangerine.domain.customization.Picklist">
        update PICKLIST 
        set 
        ENTITY_TYPE = #entityType#,
        MULTISELECT = #multiselect#,
        PICKLIST_NAME = #picklistName#,
        PICKLIST_DESC = #picklistDesc#
        where 
        SITE_NAME = #site.name#
        and PICKLIST_ID = #id#
    </update>

    <update id="UPDATE_PICKLIST_ITEM" parameterClass="com.orangeleap.tangerine.domain.customization.PicklistItem">
        update PICKLIST_ITEM
        set DEFAULT_DISPLAY_VALUE = #defaultDisplayValue#,
        INACTIVE = #inactive#,
        ITEM_NAME = #itemName#,
        ITEM_ORDER = #itemOrder#,
        REFERENCE_VALUE = #referenceValue#,
        SUPPRESS_REFERENCE_VALUE = #suppressReferenceValue#,
        PICKLIST_ID = #picklistId#
        where PICKLIST_ITEM_ID = #id#
    </update>
    
    
    <insert id="INSERT_PICKLIST" parameterClass="com.orangeleap.tangerine.domain.customization.Picklist">
    insert into PICKLIST (PICKLIST_ID, ENTITY_TYPE, MULTISELECT, PICKLIST_NAME, PICKLIST_DESC, SITE_NAME)
    values (#id#, #entityType#, #multiselect#, #picklistName#, #picklistDesc#, #site.name#)
	</insert>

    <insert id="INSERT_PICKLIST_ITEM" parameterClass="com.orangeleap.tangerine.domain.customization.PicklistItem">
		    insert into PICKLIST_ITEM (
		        DEFAULT_DISPLAY_VALUE,
		        INACTIVE,
		        ITEM_NAME, 
		        ITEM_ORDER,
		        REFERENCE_VALUE, 
		        SUPPRESS_REFERENCE_VALUE,
		        PICKLIST_ID 
		    )
		    values (
		        #defaultDisplayValue#,
		        #inactive#,
		        #itemName#,
		        #itemOrder#,
		        #referenceValue#,
		        #suppressReferenceValue#,
		        #picklistId#
		    )
		<selectKey keyProperty="id" resultClass="long">
			SELECT LAST_INSERT_ID() AS value
		</selectKey>
	</insert>
    

</sqlMap>