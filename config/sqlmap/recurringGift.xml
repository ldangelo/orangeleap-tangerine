<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="RECURRING_GIFT">

	<resultMap id="RECURRING_GIFT_RESULT" class="com.orangeleap.tangerine.domain.paymentInfo.RecurringGift" groupBy="id">
		<result property="id" column="RECURRING_GIFT_ID" jdbcType="BIGINT" />
		<result property="nextRunDate" column="NEXT_RUN_DATE" jdbcType="TIMESTAMP" />
		<result property="commitment" resultMap="COMMITMENT.COMMITMENT_RESULT" />
	</resultMap>

	<select id="SELECT_RECURRING_GIFTS_ON_OR_AFTER_DATE" resultMap="RECURRING_GIFT_RESULT" parameterClass="map">
		select rg.RECURRING_GIFT_ID, rg.NEXT_RUN_DATE,
		<include refid="COMMITMENT_COLS_FRAGMENT" />,
		<include refid="CONSTITUENT_COLS_FRAGMENT" />,
		<include refid="ADDRESS_COLS_FRAGMENT" />,
		<include refid="PHONE_COLS_FRAGMENT" />	,
		<include refid="EMAIL_COLS_FRAGMENT" />,
		<include refid="PAYMENT_SRC_COLS_FRAGMENT" />,
		<include refid="DISTRO_LINE_COLS_FRAGMENT" />
		
		from RECURRING_GIFT rg
		inner join COMMITMENT c on rg.COMMITMENT_ID = c.COMMITMENT_ID
		inner join CONSTITUENT p on c.CONSTITUENT_ID = p.CONSTITUENT_ID
		left outer join EMAIL e on c.EMAIL_ID = e.EMAIL_ID
		left outer join PHONE ph on c.PHONE_ID = ph.PHONE_ID
		left outer join ADDRESS addr on c.ADDRESS_ID = addr.ADDRESS_ID
		left outer join PAYMENT_SOURCE ps on c.PAYMENT_SOURCE_ID = ps.PAYMENT_SOURCE_ID
		left outer join DISTRO_LINE dl on c.COMMITMENT_ID = dl.COMMITMENT_ID
		
		where rg.NEXT_RUN_DATE &lt;= #date#
		and c.STATUS in
    	<iterate property="statuses" conjunction="," open="(" close=")">
			#statuses[]#
		</iterate>
	</select>
  
	<insert id="INSERT_RECURRING_GIFT" parameterClass="com.orangeleap.tangerine.domain.paymentInfo.RecurringGift">
		insert into RECURRING_GIFT (NEXT_RUN_DATE, COMMITMENT_ID)
		values (#nextRunDate#, #commitment.id#)
		<selectKey keyProperty="id" resultClass="long">
			SELECT LAST_INSERT_ID() AS value
		</selectKey>
	</insert>

	<update id="UPDATE_RECURRING_GIFT" parameterClass="com.orangeleap.tangerine.domain.paymentInfo.RecurringGift">
		update RECURRING_GIFT
		set NEXT_RUN_DATE = #nextRunDate#,
		COMMITMENT_ID = #commitment.id#
		where RECURRING_GIFT_ID = #id#
	</update>
  
	<delete id="DELETE_RECURRING_GIFT" parameterClass="map">
		delete from RECURRING_GIFT 
		where RECURRING_GIFT_ID = #id#
	</delete>
  
</sqlMap>