<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="SECTION_FIELD">

	<resultMap id="SEC_FLD_SITE_NAME_RESULT" class="com.mpower.domain.model.Site">
		<result property="name" column="SEC_FLD_SITE_NAME" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="SECONDARY_SITE_NAME_RESULT" class="com.mpower.domain.model.Site">
		<result property="name" column="SECONDARY_SITE_NAME" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="SECONDARY_FIELD_DEFINITION_RESULT" class="com.mpower.domain.model.customization.FieldDefinition">
		<result property="id" column="SECONDARY_FIELD_DEFINITION_ID" jdbcType="VARCHAR" />
		<result property="defaultLabel" column="SECONDARY_DEFAULT_LABEL" jdbcType="VARCHAR" />
		<result property="entityAttributes" column="SECONDARY_ENTITY_ATTRIBUTES" jdbcType="VARCHAR" />
		<result property="entityType" column="SECONDARY_ENTITY_TYPE" jdbcType="VARCHAR" />
		<result property="fieldInfo" column="SECONDARY_FIELD_INFO" jdbcType="VARCHAR" />
		<result property="fieldName" column="SECONDARY_FIELD_NAME" jdbcType="VARCHAR" />
		<result property="fieldType" column="SECONDARY_FIELD_TYPE" jdbcType="VARCHAR" />
		<result property="referenceType" column="SECONDARY_REFERENCE_TYPE" jdbcType="VARCHAR" />
		<result property="site" resultMap="SECTION_FIELD.SECONDARY_SITE_NAME_RESULT" />
	</resultMap>	

	<resultMap id="SECTION_FIELD_RESULT" class="com.mpower.domain.model.customization.SectionField">
		<result property="id" column="SECTION_FIELD_ID" jdbcType="BIGINT" />
		<result property="fieldOrder" column="SEC_FLD_FIELD_ORDER" jdbcType="INTEGER" />
		<result property="fieldDefinition" resultMap="FIELD_DEFINITION.FIELD_DEFINITION_RESULT" />
		<result property="secondaryFieldDefinition" resultMap="SECTION_FIELD.SECONDARY_FIELD_DEFINITION_RESULT" />
		<result property="sectionDefinition" resultMap="SECTION_DEFINITION.SECTION_DEFINITION_RESULT" />
		<result property="site" resultMap="SECTION_FIELD.SEC_FLD_SITE_NAME_RESULT" />
	</resultMap>


	<sql id="SELECT_SECTION_FIELD_FRAGMENT">
		select sf.SECTION_FIELD_ID, sf.FIELD_ORDER as SEC_FLD_FIELD_ORDER, 
		sf.SECTION_DEFINITION_ID as SECTION_DEFINITION_ID, sf.SITE_NAME as SEC_FLD_SITE_NAME,
		
		
		sd.SECTION_DEFINITION_ID, sd.DEFAULT_LABEL as SEC_DEF_DEFAULT_LABEL, sd.LAYOUT_TYPE as SEC_DEF_LAYOUT_TYPE, 
		sd.PAGE_TYPE as SEC_DEF_PAGE_TYPE, sd.ROLE as SEC_DEF_ROLE, sd.SECTION_NAME as SEC_DEF_SECTION_NAME, 
		sd.SECTION_ORDER as SEC_DEF_SECTION_ORDER, sd.SITE_NAME as SEC_DEF_SITE_NAME,
		
		
		fd.FIELD_DEFINITION_ID, fd.DEFAULT_LABEL as FLD_DEF_DEFAULT_LABEL, fd.ENTITY_ATTRIBUTES as FLD_DEF_ENTITY_ATTRIBUTES, 
		fd.ENTITY_TYPE as FLD_DEF_ENTITY_TYPE, fd.FIELD_INFO as FLD_DEF_FIELD_INFO, fd.FIELD_NAME as FLD_DEF_FIELD_NAME, 
		fd.FIELD_TYPE as FLD_DEF_FIELD_TYPE, fd.REFERENCE_TYPE as FLD_DEF_REFERENCE_TYPE, fd.SITE_NAME as FLD_DEF_SITE_NAME,
		
		
		sfd.FIELD_DEFINITION_ID as SECONDARY_FIELD_DEFINITION_ID, sfd.DEFAULT_LABEL as SECONDARY_DEFAULT_LABEL, sfd.ENTITY_ATTRIBUTES as SECONDARY_ENTITY_ATTRIBUTES, 
		sfd.ENTITY_TYPE as SECONDARY_ENTITY_TYPE, sfd.FIELD_INFO as SECONDARY_FIELD_INFO, sfd.FIELD_NAME as SECONDARY_FIELD_NAME, 
		sfd.FIELD_TYPE as SECONDARY_FIELD_TYPE, sfd.REFERENCE_TYPE as SECONDARY_REFERENCE_TYPE, sfd.SITE_NAME as SECONDARY_SITE_NAME
		
		
		from SECTION_FIELD sf
		inner join SECTION_DEFINITION sd on sf.SECTION_DEFINITION_ID = sd.SECTION_DEFINITION_ID
		inner join FIELD_DEFINITION fd on sf.FIELD_DEFINITION_ID = fd.FIELD_DEFINITION_ID 
		left outer join FIELD_DEFINITION sfd on sf.SECONDARY_FIELD_DEFINITION_ID = sfd.FIELD_DEFINITION_ID
	</sql>

	<!-- Customized fields per site -->
	<select id="SELECT_CUSTOMIZED_SEC_FLDS" resultMap="SECTION_FIELD_RESULT" parameterClass="map">
		<include refid="SELECT_SECTION_FIELD_FRAGMENT"/>		 
		where sf.SECTION_DEFINITION_ID = #sectionDefinitionId#
		and sf.SITE_NAME = #siteName#
	</select>

	<!-- Out of the box fields -->
	<select id="SELECT_OUT_OF_BOX_SEC_FLDS" resultMap="SECTION_FIELD_RESULT" parameterClass="map">
		<include refid="SELECT_SECTION_FIELD_FRAGMENT"/>		 
		where sf.SITE_NAME is NULL
		and sd.PAGE_TYPE = #pageType#
		and sd.SECTION_NAME = #sectionName#
	</select>

	<insert id="INSERT_SECTION_FIELD" parameterClass="com.mpower.domain.model.customization.SectionField">
		insert into SECTION_FIELD (SECTION_FIELD_ID, FIELD_ORDER, FIELD_DEFINITION_ID,
		SECONDARY_FIELD_DEFINITION_ID, SECTION_DEFINITION_ID, SITE_NAME)
		values (#id#, #fieldOrder#, #fieldDefinition.id#,
		#secondaryFieldDefinition.id#, #sectionDefinition.id#, #site.name#)
		<selectKey keyProperty="id" resultClass="long">
			SELECT LAST_INSERT_ID() AS value
		</selectKey>
	</insert>


	<update id="UPDATE_SECTION_FIELD" parameterClass="com.mpower.domain.model.customization.SectionField">
		update SECTION_FIELD
		set FIELD_ORDER = #fieldOrder#,
		FIELD_DEFINITION_ID = #fieldDefinition.id#,
		SECONDARY_FIELD_DEFINITION_ID = #secondaryFieldDefinition.id#,
		SECTION_DEFINITION_ID = #sectionDefinition.id#,
		SITE_NAME = #site.name#
		where SECTION_FIELD_ID = #id#
  </update>
</sqlMap>