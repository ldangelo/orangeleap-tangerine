<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/integration"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:beans="http://www.springframework.org/schema/beans"
	xmlns:jms="http://www.springframework.org/schema/integration/jms"
	xmlns:stream="http://www.springframework.org/schema/integration/stream"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
			http://www.springframework.org/schema/integration
			http://www.springframework.org/schema/integration/spring-integration-1.0.xsd
			http://www.springframework.org/schema/integration/jms
			http://www.springframework.org/schema/integration/jms/spring-integration-jms-1.0.xsd			
			http://www.springframework.org/schema/integration/stream
			http://www.springframework.org/schema/integration/stream/spring-integration-stream-1.0.xsd">


  <beans:bean id="connectionFactory" class="org.springframework.jms.connection.CachingConnectionFactory">
    <beans:property name="targetConnectionFactory">
      <beans:bean class="org.apache.activemq.ActiveMQConnectionFactory">
	<beans:property name="brokerURL" value="tcp://localhost:61616"/>		
      </beans:bean>
    </beans:property>
    <beans:property name="sessionCacheSize" value="10"/>
    <beans:property name="cacheProducers" value="false"/>
  </beans:bean>

  <beans:bean id="GiftDestination" class="org.apache.activemq.command.ActiveMQQueue">
    <beans:constructor-arg value="queue.orangeleap.tangerine.gift"/>
  </beans:bean>
  
  <beans:bean id="ConstituentDestination" class="org.apache.activemq.command.ActiveMQQueue">
  	<beans:constructor-arg value="queue.orangeleap.tangerine.constituent"/>
  </beans:bean>
  
  <gateway id="newConstituent" service-interface="com.orangeleap.tangerine.integration.NewConstituent"/>
  
  <gateway id="newGift" service-interface="com.orangeleap.tangerine.integration.NewGift"/>
<!--  <gateway id="newConstituent" service-interface="com.orangeleap.tangerine.integration.NewConstituent"/>
  <gateway id="newAddress" service-interface="com.orangeleap.tangerine.integration.NewAddress"/> -->

  <channel id="newGiftChannel"/>
  <channel id="newConstituentChannel"/>
  <channel id="newAddressChannel"/>
  <channel id="gift_drools_channel"/>
  <channel id="constituent_drools_channel"/>
  <channel id="constituent_transformer"/>
  <channel id="constituent_marshalling_transformer"/>
    <channel id="gift_transformer"/>
    <channel id="gift_marshalling_transformer"/>
  <channel id="gift_jms_channel"/>
  <channel id="constituent_jms_channel"/>
  <channel id="payment_drools_channel"/>

  <service-activator input-channel="gift_drools_channel" ref="GiftDrools" method="doApplyRules"/>
  <service-activator input-channel="payment_drools_channel" ref="PaymentDrools" method="doApplyRules"/>
  <service-activator input-channel="constituent_drools_channel" ref="ConstituentDrools" method="doApplyRules"/>
  <!--  <service-activator input-channel="constituent_drools_channel" ref="ConstituentDrools" method="doApplyRules"/> -->
  
  <router id="routerEndpoint" input-channel="newGiftChannel" ref="giftRouter"/>
  <router id="routerEndpointConstituents" input-channel="newConstituentChannel" ref="constituentRouter"/>
  
  <beans:bean id="constituentRouter" class="org.springframework.integration.router.RecipientListRouter">
  	<beans:property name="channels">
  		<beans:list>
  			<beans:ref bean="constituent_drools_channel"/>
            <beans:ref bean="constituent_transformer"/>
  		</beans:list>
  	</beans:property>
  </beans:bean>
  
  <beans:bean id="giftRouter" class="org.springframework.integration.router.RecipientListRouter">
    <beans:property name="channels">
      <beans:list>
		<beans:ref bean="gift_drools_channel"/>
		<beans:ref bean="payment_drools_channel"/>
 		<beans:ref bean="gift_transformer"/>
      </beans:list>
    </beans:property>
  </beans:bean>

  <transformer input-channel="constituent_transformer" output-channel="constituent_marshalling_transformer" ref="constituentToConstituentTransformer"/>
  <transformer input-channel="gift_transformer" output-channel="gift_marshalling_transformer" ref="giftTransformer"/>

  <beans:bean id="marshallingTransformer" class="org.springframework.integration.xml.transformer.XmlPayloadMarshallingTransformer">
      <beans:constructor-arg>
          <beans:bean class="org.springframework.oxm.jaxb.Jaxb2Marshaller">
            <beans:property name="classesToBeBound">
            <beans:list>
                <beans:value>com.orangeleap.tangerine.ws.schema.SaveOrUpdateConstituentRequest</beans:value>
                <beans:value>com.orangeleap.tangerine.ws.schema.ConstituentResponse</beans:value>
                <beans:value>com.orangeleap.tangerine.ws.schema.CreateDefaultConstituentRequest</beans:value>
                <beans:value>com.orangeleap.tangerine.ws.schema.GetSegmentationRequest</beans:value>
                <beans:value>com.orangeleap.tangerine.ws.schema.GiftResponse</beans:value>
                <beans:value>com.orangeleap.tangerine.ws.schema.GetConstituentGiftRequest</beans:value>
                <beans:value>com.orangeleap.tangerine.ws.schema.SaveOrUpdateGiftRequest</beans:value>
                <beans:value>com.orangeleap.tangerine.ws.schema.SearchConstituentsRequest</beans:value>
                <beans:value>com.orangeleap.tangerine.ws.schema.FindConstituentsRequest</beans:value>
            </beans:list>
        </beans:property>
          </beans:bean>
      </beans:constructor-arg>
      <beans:constructor-arg>
          <beans:bean class="org.springframework.integration.xml.transformer.ResultToStringTransformer"/>
      </beans:constructor-arg>
  </beans:bean>

  <transformer input-channel="constituent_marshalling_transformer" output-channel="constituent_jms_channel" ref="marshallingTransformer">
  </transformer>
  <transformer input-channel="gift_marshalling_transformer" output-channel="gift_jms_channel" ref="marshallingTransformer"/>

  <beans:bean id="AbstractRulesInterceptor" class="com.orangeleap.tangerine.service.rule.RulesInterceptor" abstract="true">
    <beans:constructor-arg value="${drools.host}" index="0" />
    <beans:constructor-arg value="${drools.port}" index="1" />
  </beans:bean>

  <beans:bean id="GiftDrools" class="com.orangeleap.tangerine.service.rule.GiftRulesInterceptor" parent="AbstractRulesInterceptor"/>

  <beans:bean id="PaymentDrools" class="com.orangeleap.tangerine.service.rule.PaymentRulesInterceptor"/>
  
  <beans:bean id="ConstituentDrools" class="com.orangeleap.tangerine.service.rule.ConstituentRulesInterceptor"/>
  
  <beans:bean id="emailInterceptor" class="com.orangeleap.tangerine.service.rule.EmailRulesInterceptor">
  	<beans:property name="agendaGroup" value="email"/>
  </beans:bean>

  <beans:bean id="DroolsRuleAgent" class="com.orangeleap.tangerine.service.rule.DroolsRuleAgent">
    <beans:constructor-arg value="${drools.pollinterval}" index="0"/>
    <beans:constructor-arg value="${drools.cachedir}" index="1" />
    <beans:constructor-arg value="${drools.packagedir}" index="2" />
  </beans:bean>

  <jms:outbound-gateway id="ConstituentJms" request-channel="constituent_jms_channel" request-destination="ConstituentDestination" />
  <jms:outbound-gateway id="GiftJms" request-channel="gift_jms_channel" request-destination="GiftDestination" />

	<poller id="poller" default="true">
		<interval-trigger interval="1000"/>
	</poller>

</beans:beans>